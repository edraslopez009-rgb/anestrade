<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ANESTRADE Studio</title>
<style>
  body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:sans-serif; }
  #ui { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; }
  #explorer { width:200px; background:#222; color:#fff; padding:10px; overflow:auto; }
  #scripting { width:300px; background:#111; color:#0f0; padding:10px; display:flex; flex-direction:column;}
  #desktop { flex:1; position:relative; }
  #canvas { width:100%; height:100%; background:#000; }
  textarea { flex:1; width:100%; background:#000; color:#0f0; border:none; resize:none; }
  button { background:#444; color:#fff; border:none; padding:5px; margin-top:5px; cursor:pointer; }
</style>
</head>
<body>

<div id="ui">
  <!-- Explorer -->
  <div id="explorer">
    <h3>Explorer</h3>
    <div id="objects"></div>
  </div>

  <!-- 3D Desktop & Scripting Panel -->
  <div id="desktop">
    <canvas id="canvas"></canvas>
    <div id="scripting">
      <h3>Lua Script</h3>
      <textarea id="luaCode">print("Hello from ANESTRADE Lua")</textarea>
      <button id="runScript">Run Script</button>
    </div>
  </div>
</div>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r148/three.min.js"></script>

<!-- Fengari: Lua in Browser -->
<script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>

<script>
/* ===================== 3D WORLD SETUP ===================== */

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/(window.innerHeight), 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("canvas") });
renderer.setSize(window.innerWidth, window.innerHeight);

camera.position.z = 5;

// Basic Cube
const geometry = new THREE.BoxGeometry();
const material = new THREE.MeshNormalMaterial();
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);

// Render Loop
function animate() {
    requestAnimationFrame(animate);
    cube.rotation.x += 0.01;
    cube.rotation.y += 0.01;
    renderer.render(scene, camera);
}
animate();

/* ===================== EXPLORER ===================== */

function refreshExplorer() {
    const container = document.getElementById("objects");
    container.innerHTML = "";
    scene.children.forEach((obj, i) => {
        const div = document.createElement("div");
        div.textContent = `Object ${i}: ${obj.type}`;
        container.appendChild(div);
    });
}
refreshExplorer();

/* ================ LUA SCRIPT EXECUTION ================ */

// Run Lua and allow basic effects on scene objects
document.getElementById("runScript").onclick = () => {
    const luaCode = document.getElementById("luaCode").value;

    try {
        fengari.load(luaCode)();
        alert("Lua ran successfully!");
    } catch(e) {
        alert("Lua error: " + e);
    }

    // After script runs, save to URL
    saveToURL();
};

/* ================ URL SAVING / LOADING ================ */

function saveToURL() {
    const state = {
        script: document.getElementById("luaCode").value,
        objects: scene.children.map(obj => ({
            type: obj.type,
            position: obj.position.toArray()
        }))
    };
    const hash = btoa(JSON.stringify(state));
    location.hash = hash;
}

function loadFromURL() {
    if(location.hash.length > 1) {
        try {
            const decoded = atob(location.hash.substring(1));
            const state = JSON.parse(decoded);

            // Apply script
            if(state.script) {
                document.getElementById("luaCode").value = state.script;
            }

            // Clear scene then re-add
            scene.children.forEach((obj) => {
                if(obj !== camera) scene.remove(obj);
            });
            if(Array.isArray(state.objects)) {
                state.objects.forEach(o => {
                    const g = new THREE.BoxGeometry();
                    const m = new THREE.MeshNormalMaterial();
                    const obj3d = new THREE.Mesh(g, m);
                    obj3d.position.fromArray(o.position);
                    scene.add(obj3d);
                });
            }

            refreshExplorer();
        } catch(e) {
            console.warn("Could not load state:", e);
        }
    }
}

loadFromURL();

/* ================ RESIZE HANDLING ================ */

window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
